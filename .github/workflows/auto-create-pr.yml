name: Auto Create Pull Request

on:
  push:
    branches-ignore:
      - main

permissions:
  pull-requests: write
  contents: read

jobs:
  create-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if PR already exists
        id: check-pr
        run: |
          # ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒåã‚’å–å¾—
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"

          # æ—¢å­˜ã®PRã‚’ãƒã‚§ãƒƒã‚¯
          PR_EXISTS=$(gh pr list --head "$BRANCH_NAME" --json number --jq 'length')

          if [ "$PR_EXISTS" -gt 0 ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "PR already exists for branch $BRANCH_NAME"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "No PR found for branch $BRANCH_NAME"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get commit info
        id: commit-info
        if: steps.check-pr.outputs.exists == 'false'
        run: |
          # æœ€æ–°ã®ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
          COMMIT_MSG=$(git log -1 --pretty=%B)
          COMMIT_TITLE=$(echo "$COMMIT_MSG" | head -n1)

          # ãƒ–ãƒ©ãƒ³ãƒåã‹ã‚‰PRã‚¿ã‚¤ãƒˆãƒ«ã‚’æŽ¨æ¸¬
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"

          # PRã‚¿ã‚¤ãƒˆãƒ«: ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®1è¡Œç›®ã‚’ä½¿ç”¨
          echo "title=$COMMIT_TITLE" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.check-pr.outputs.exists == 'false'
        run: |
          BRANCH_NAME="${{ steps.commit-info.outputs.branch }}"
          COMMIT_SHA="${{ github.sha }}"

          gh pr create \
            --title "${{ steps.commit-info.outputs.title }}" \
            --body "## Summary
          è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ

          **Branch:** ${BRANCH_NAME}
          **Latest commit:** ${COMMIT_SHA}

          ## Changes
          ã“ã®PRã¯ \`${BRANCH_NAME}\` ãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰è‡ªå‹•ä½œæˆã•ã‚Œã¾ã—ãŸã€‚

          ## Checklist
          - [ ] ã‚³ãƒ¼ãƒ‰å¤‰æ›´ã‚’ç¢ºèª
          - [ ] ãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã“ã¨ã‚’ç¢ºèª
          - [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰

          ---
          ðŸ¤– This PR was automatically created by GitHub Actions" \
            --base main \
            --head "${{ steps.commit-info.outputs.branch }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        if: steps.check-pr.outputs.exists == 'false'
        run: |
          echo "âœ… Pull Request created successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Title:** ${{ steps.commit-info.outputs.title }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ steps.commit-info.outputs.branch }} â†’ main" >> $GITHUB_STEP_SUMMARY
